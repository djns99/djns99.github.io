<html>
<head>
<script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
</head>

<body>
    <!-- 
    *********************************
    No peaking. Roll an arcana check! 
    *********************************
    -->
    <script>        
        current_string = ""
        unlocked = false
        reset_count = 0
        digits = []
        function setup()
        {
            createCanvas(400,400)
            for(i = 0; i < 10; i++)
            {
                digits.push(new Digit(i))
            }
        }

        
        function grant_access()
        {
            console.log("Access Granted " + current_string)
            unlocked = true
        }
        
        function check_access()
        { 
            // console.log("Checking " + current_string)
            
            num = parseInt(current_string, 10)
            if(num % 10 != 9)
            {
                reset()
                return
            }
            
            if( (num % 100) + (Math.floor(num/100) % 100) != 85 )
            {
                reset()
                return
            }
           
            if((parseInt(current_string[0]) % 2) == 1)
            {
                reset()
                return
            }
           
            if( parseInt(current_string[0]) != parseInt(current_string[2]) + 1 )
            {
                reset()
                return
            }
           
            grant_access();
        }
        
        function click_digit(digit)
        {
            console.log("Clicked digit " + digit)
            if(current_string.length == 4)
            {
                reset()
            }
            
            current_string += digit
            
            if(current_string.length == 4)
            {
              check_access();
            }
        }
        
        function reset()
        {
            console.log("Reset")
            reset_count = 50
        }

        class Digit
        {
            constructor(digit)
            {
                this.digit = digit
                let angle = radians(36 * digit - 90);
                this.x = 200 + cos(angle) * 150;
                this.y = 200 + sin(angle) * 150;
            }
            
            display()
            {
                if(reset_count % 10 >= 5)
                {
                    fill(255, 0, 0)
                }
                else if(unlocked)
                {
                    fill(0, 255, 0)
                }
                else
                {
                    fill(255)
                }
            
                ellipse(this.x, this.y, 60, 60)
                
                fill(0)
                
                textAlign(CENTER, CENTER);
                textSize(50)
                text(this.digit.toString(), this.x, this.y)
                
                fill(255)
            }
            
            clicked()
            {
                if (dist(mouseX, mouseY, this.x, this.y) < 30) {
                    click_digit(this.digit)
                }
            }
        }
    
   
        function draw()
        {
            background(255)
                        
            digits.forEach( digit => digit.display() )
            
            if(reset_count > 0)
            {
                reset_count -= 1
                if( reset_count == 0 )
                {
                    current_string = ""
                }
            }
            
            fill(0)

            for(i = 0; i < 4; i++)
            {
                c = "_"
                if(i < current_string.length)
                {
                    c = current_string[i]
                }
                textAlign(CENTER, CENTER);
                textSize(50)
                text( c, 120 + 55 * i, 200 )
            }
            
            if(unlocked)
            {
                fill(0,196,0)
                rect(50, 100, 300, 200 )
                fill(0)
                textAlign(CENTER, CENTER)
                textSize(50)
                text("DOOR\nUNLOCKED", 200, 200)            
            }
        }
    
        function mousePressed(){
          if(!unlocked && reset_count == 0 )
          {
            digits.forEach( digit => digit.clicked() )
          }
        }
    </script>
</body>
</html>
